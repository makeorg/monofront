include:
  - project: 'makeorg/infrastructure/pipeline/templates'
    file: 'pipelines/monorepo.yml'

# Variable
variables:
  APP_NAME: assembly-ui
  APP_WORKSPACE: '@make.org/assembly-ui'
  IMAGE_NAME: $NEXUS_URL/assembly-ui-beta
  IMAGE_APP_TARGET: app-production
  IMAGE_APP_PATH: apps/assembly-ui/Dockerfile
  RUNDECK_JOB_ID: $RUNDECK_ASSEMBLY_UI_BETA_JOB_ID

# Stage
stages:
  - check
  - build
  - deploy
  - merge

# Workflow
workflow:
  rules:
    - !reference [.rules, on-merge-request]
    - !reference [.rules, on-protected-branch]

# Rule
.rules-env:
  on-assembly-ui-beta-preproduction:
    if: $CI_COMMIT_BRANCH == "assembly-ui-beta-preproduction"
  on-assembly-ui-beta-production:
    if: $CI_COMMIT_BRANCH == "assembly-ui-beta-production"

# Template
.on-assembly-ui-beta-preproduction:
  rules:
    - !reference [.rules-env, on-assembly-ui-beta-preproduction]
.on-assembly-ui-beta-production:
  rules:
    - !reference [.rules-env, on-assembly-ui-beta-production]

# Environment
.preprod:
  extends: .on-assembly-ui-beta-preproduction
  environment: preproduction

.prod:
  extends: .on-assembly-ui-beta-production
  environment: production
  when: manual

# Check
.check:
  stage: check
  extends: .on-merge-request
  tags:
    - large
  variables:
    YARN_VERSION: '3.2.3'
  image: node:18.17-alpine
  before_script:
    - node -v
    - corepack enable yarn
    - corepack prepare
    - yarn install

# Check
lint:
  extends: .check
  script:
    - yarn eslint ./

check-types:
  extends: .check
  script:
    - yarn tsc --noEmit

test:
  extends: .check
  script:
    - yarn jest --coverage
  artifacts:
    expire_in: 1 week
    when: always
    paths:
      - coverage

jscpd:
  extends: .check
  script:
    - yarn jscpd
  artifacts:
    expire_in: 1 week
    when: always
    paths:
      - reports

# Build
build-assembly-ui-beta:
  extends:
    - .build

# Deploy
deploy-assembly-ui-beta-preproduction:
  extends:
    - .deploy
    - .preprod

deploy-assembly-ui-beta-production:
  extends:
    - .deploy
    - .prod

# Merge
merge-to-assembly-ui-beta-prod:
  extends:
    - .merge
    - .on-assembly-ui-beta-preproduction
  script:
    - mkdir -p ~/.ssh/
    - chmod 700 ~/.ssh
    - ssh-keyscan -t rsa gitlab.com > ~/.ssh/known_hosts
    - echo "${DEPLOY_PRIVATE_KEY}" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - export CI_PUSH_REPO=`echo $CI_REPOSITORY_URL | perl -pe 's#.*@(.+?(\:\d+)?)/#git@\1:#'`
    - echo "Target repo is ${CI_PUSH_REPO}"
    - git config --global user.email "${GITLAB_USER_EMAIL}"
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git remote set-url origin "${CI_PUSH_REPO}"
    - git checkout assembly-ui-beta-production
    - git merge --ff-only origin/assembly-ui-beta-preproduction
    - git push origin assembly-ui-beta-production:assembly-ui-beta-production
